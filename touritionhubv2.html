<!DOCTYPE html>
<html lang="bn" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tourition Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-bg: #0F1021; --secondary-bg: #1C1A3A; --card-bg: #1E203B;
            --accent-color: #8A4DFF; --text-primary: #FFFFFF; --text-secondary: #A0AEC0;
        }
        body { font-family: 'Poppins', sans-serif; }
        .hidden { display: none !important; }
        .screen { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal { display: flex; }
        .modal-content::-webkit-scrollbar, #chatMessagesContainer::-webkit-scrollbar, #inviteUserList::-webkit-scrollbar, #qualifyGroupsContainer::-webkit-scrollbar { width: 5px; }
        .modal-content::-webkit-scrollbar-track, #chatMessagesContainer::-webkit-scrollbar-track, #inviteUserList::-webkit-scrollbar-track, #qualifyGroupsContainer::-webkit-scrollbar-track { background: var(--secondary-bg); }
        .modal-content::-webkit-scrollbar-thumb, #chatMessagesContainer::-webkit-scrollbar-thumb, #inviteUserList::-webkit-scrollbar-thumb, #qualifyGroupsContainer::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 10px; }
        .nav-item.active i, .nav-item.active span { color: var(--accent-color); }
        .nav-item { color: var(--text-secondary); }
        .tab-btn.active { border-color: var(--accent-color); color: var(--accent-color); }
        .chat-message-text { white-space: pre-wrap; word-wrap: break-word; }
        .chat-message-text img { max-width: 100%; border-radius: 0.5rem; margin-top: 0.5rem; }
        .achievement-badge { filter: grayscale(1); opacity: 0.5; transition: all 0.3s; }
        .achievement-badge.unlocked { filter: grayscale(0); opacity: 1; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-bg': '#0F1021', 'secondary-bg': '#1C1A3A', 'card-bg': '#1E203B',
                        'accent': '#8A4DFF', 'text-primary': '#FFFFFF', 'text-secondary': '#A0AEC0',
                        'success': '#10B981', 'warning': '#F59E0B', 'danger': '#EF4444',
                        'tier-bronze': '#cd7f32', 'tier-silver': '#c0c0c0', 'tier-gold': '#ffd700', 'tier-platinum': '#e5e4e2'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-primary-bg text-text-primary">
    <div id="appContainer" class="max-w-md min-h-screen mx-auto bg-primary-bg relative pt-16 pb-24">
        <header class="fixed top-0 left-0 right-0 max-w-md mx-auto bg-primary-bg/80 backdrop-blur-lg px-5 flex items-center justify-between z-50 h-16 border-b border-white/10">
            <button class="header-btn back-btn text-xl p-2 w-10 text-center" id="backBtn" style="visibility: hidden;"><i class="fas fa-chevron-left"></i></button>
            <h1 class="page-title text-xl font-semibold absolute left-1/2 -translate-x-1/2" id="pageTitle">Tourition Hub</h1>
            <button class="header-btn menu-btn hidden text-xl p-2 w-10 text-center" id="menuBtn" data-screen="menuScreen"><i class="fas fa-bars"></i></button>
        </header>

        <main id="mainContent" class="p-5">
            <!-- Screens are rendered here by JavaScript -->
        </main>
        
        <nav class="bottom-nav hidden fixed bottom-0 left-0 right-0 max-w-md mx-auto h-20 bg-primary-bg/80 backdrop-blur-lg grid grid-cols-3 justify-around items-center border-t border-white/10 z-50">
            <div class="nav-item flex flex-col items-center text-xs font-medium cursor-pointer" data-screen="homeScreen"><i class="fas fa-home text-xl mb-1"></i><span>Home</span></div>
            <div class="nav-item flex flex-col items-center text-xs font-medium cursor-pointer" data-screen="walletScreen"><i class="fas fa-wallet text-xl mb-1"></i><span>Wallet</span></div>
            <div class="nav-item flex flex-col items-center text-xs font-medium cursor-pointer" data-screen="profileScreen"><i class="fas fa-user text-xl mb-1"></i><span>Profile</span></div>
        </nav>

        <div id="contactFab" data-screen="contactScreen" class="hidden fixed bottom-24 right-5 z-40 w-14 h-14 bg-accent rounded-full flex items-center justify-center text-white shadow-lg cursor-pointer hover:bg-purple-500 transition-colors">
            <i class="fas fa-headset text-2xl"></i>
        </div>
    </div>

    <div id="modalContainer"></div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
      import { getFirestore, doc, setDoc, getDoc, collection, getDocs, addDoc, updateDoc, serverTimestamp, deleteDoc, query, where, orderBy, onSnapshot, writeBatch, arrayUnion, arrayRemove, limit, runTransaction, increment } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
      import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-messaging.js";
      
      const firebaseConfig = {
        apiKey: "AIzaSyC3vBI-1FefY4Ft4Cks62hH9CL1IClds_Q",
        authDomain: "e-sports-24ac6.firebaseapp.com",
        projectId: "e-sports-24ac6",
        storageBucket: "e-sports-24ac6.firebasestorage.app",
        messagingSenderId: "984168922563",
        appId: "1:984168922563:web:973d536ac2d24a364f5176",
      };

      const currentAppVersion = "1.0.2"; 

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      
      async function setupNotifications(userId) {
          const supported = await isSupported();
          if (!supported) {
              console.log("This browser does not support Firebase Messaging.");
              return;
          }
          const messaging = getMessaging(app);
          try {
              const permission = await Notification.requestPermission();
              if (permission === 'granted') {
                  const fcmToken = await getToken(messaging, { vapidKey: 'BHJf0Pu5Jdwm1RY6Nq_1WdaXojLmbh8aQTSDp9DAQIV1OJVM8an9HZSOMyr80eoD3pJHcXc-UvRDP2EeNYPq_1s' });
                  if (fcmToken) {
                      await updateDoc(doc(db, 'users', userId), { fcmToken: fcmToken });
                  }
              }
          } catch (error) {
              console.error('An error occurred while requesting notification permission:', error);
          }
          onMessage(messaging, (payload) => {
              new Notification(payload.notification.title, {
                  body: payload.notification.body,
                  icon: payload.notification.icon || '/favicon.ico', // Default icon
              });
          });
      }

      const state = { currentUser: null, currentUserData: null, currentScreen: null, screenHistory: [], listeners: {}, currentChatContext: null, currentScreenContext: {}, loadedData: { tournaments: {} } };
      const mainContent = document.getElementById('mainContent');
      const pageTitle = document.getElementById('pageTitle');
      const backBtn = document.getElementById('backBtn');
      const menuBtn = document.getElementById('menuBtn');
      const bottomNav = document.querySelector('.bottom-nav');
      const modalContainer = document.getElementById('modalContainer');
      const contactFab = document.getElementById('contactFab');
      
      const achievementsData = {
          'first_blood': { name: 'First Blood', description: 'Win your first tournament match.', icon: 'fa-trophy' },
          'veteran': { name: 'Veteran', description: 'Complete 50 tournament matches.', icon: 'fa-shield-alt' },
          'headshot_master': { name: 'Headshot Master', description: 'Get 10+ kills in a single match.', icon: 'fa-crosshairs' },
          'loyal_squad': { name: 'Loyal Squad', description: 'Play 20 matches with the same squad.', icon: 'fa-users' },
      };

      const getRatingTier = (points) => {
          if (points >= 1000) return { name: 'Platinum', color: 'tier-platinum', icon: 'fa-gem' };
          if (points >= 500) return { name: 'Gold', color: 'tier-gold', icon: 'fa-shield-alt' };
          if (points >= 200) return { name: 'Silver', color: 'tier-silver', icon: 'fa-shield-alt' };
          return { name: 'Bronze', color: 'tier-bronze', icon: 'fa-shield-alt' };
      };

      const ui = {
        loading: () => `<div class="text-center p-10 text-text-secondary">Loading...</div>`,
        loginScreen: () => `<div class="screen text-center py-10" id="loginScreen"><h2 class="text-3xl font-bold mb-6">Welcome Back!</h2><form id="loginForm"><div class="mb-4 text-left"><input type="email" id="loginEmail" placeholder="Email" required class="w-full bg-card-bg border border-white/10 rounded-xl py-3.5 px-4 text-text-primary text-sm"></div><div class="mb-4 text-left"><input type="password" id="loginPassword" placeholder="Password" required class="w-full bg-card-bg border border-white/10 rounded-xl py-3.5 px-4 text-text-primary text-sm"></div><button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 rounded-xl text-base font-semibold mt-4">Login</button></form><p class="mt-4 text-sm text-text-secondary"><span id="forgotPassword" class="text-accent font-semibold cursor-pointer">Forgot Password?</span></p><p class="mt-6 text-sm text-text-secondary">Don't have an account? <span id="showRegister" class="text-accent font-semibold cursor-pointer">Register</span></p></div>`,
        registerScreen: () => `<div class="screen text-center py-10" id="registerScreen"><h2 class="text-3xl font-bold mb-6">Create Account</h2><form id="registerForm"><div class="mb-4 text-left"><input type="text" id="registerUsername" placeholder="Username" required class="w-full bg-card-bg border border-white/10 rounded-xl py-3.5 px-4 text-sm"></div><div class="mb-4 text-left"><input type="text" id="registerIngameName" placeholder="In-Game Name" required class="w-full bg-card-bg border border-white/10 rounded-xl py-3.5 px-4 text-sm"></div><div class="mb-4 text-left"><input type="text" id="registerIngameUID" placeholder="In-Game UID" required class="w-full bg-card-bg border border-white/10 rounded-xl py-3.5 px-4 text-sm"></div><div class="mb-4 text-left"><input type="email" id="registerEmail" placeholder="Email" required class="w-full bg-card-bg border border-white/10 rounded-xl py-3.5 px-4 text-sm"></div><div class="mb-4 text-left"><input type="password" id="registerPassword" placeholder="Password" required minlength="6" class="w-full bg-card-bg border border-white/10 rounded-xl py-3.5 px-4 text-sm"></div><button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 rounded-xl text-base font-semibold mt-4">Register</button></form><p class="mt-6 text-sm text-text-secondary">Already have an account? <span id="showLogin" class="text-accent font-semibold cursor-pointer">Login</span></p></div>`,
        homeScreen: () => `<div class="screen" id="homeScreen"><section class="mb-8"><div id="homeBanner" class="h-48 rounded-2xl overflow-hidden relative bg-cover bg-center bg-secondary-bg"><div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent p-5 flex flex-col justify-end"><h2 id="bannerTitle" class="text-xl font-bold mb-2">Loading...</h2><button data-screen="squadTournamentsScreen" class="bg-white/90 text-black py-2 px-4 rounded-lg text-xs font-semibold w-fit">VIEW ALL</button></div></div></section><section class="mb-8"><h3 class="text-lg font-semibold mb-4">Tournament Rooms</h3><div class="grid grid-cols-3 gap-3"><div class="room-item bg-card-bg rounded-xl p-5 text-center cursor-pointer border border-white/10" data-screen="soloTournamentsScreen"><i class="fas fa-user text-2xl text-accent mb-2"></i><span>Solo</span></div><div class="room-item bg-card-bg rounded-xl p-5 text-center cursor-pointer border border-white/10" data-screen="duoTournamentsScreen"><i class="fas fa-users text-2xl text-accent mb-2"></i><span>Duo</span></div><div class="room-item bg-card-bg rounded-xl p-5 text-center cursor-pointer border border-white/10" data-screen="squadTournamentsScreen"><i class="fas fa-users-cog text-2xl text-accent mb-2"></i><span>Squad</span></div></div></section><section class="mb-8"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold">News & Updates</h3></div><div id="newsContainer" class="flex flex-col gap-3"></div></section><section id="appUpdateSection" class="mb-8 hidden"><h3 class="text-lg font-semibold mb-4">App Update</h3><div id="appUpdateContainer"></div></section></div>`,
        profileScreen: (userData) => { 
            if (!userData) return ui.loading(); 
            const hasSquad = !!userData.squadId, hasPartner = !!userData.partnerId;
            const stats = userData.stats || { played: 0, won: 0 };
            const winRate = stats.played > 0 ? ((stats.won / stats.played) * 100).toFixed(1) : 0;
            const ratingTier = getRatingTier(userData.ratingPoints || 0);
            const userAchievements = userData.achievements || [];

            let achievementsHtml = Object.keys(achievementsData).map(key => {
                const isUnlocked = userAchievements.includes(key);
                const achievement = achievementsData[key];
                return `<div class="flex flex-col items-center achievement-badge ${isUnlocked ? 'unlocked' : ''}" title="${achievement.description}">
                    <div class="w-12 h-12 rounded-full bg-secondary-bg flex items-center justify-center text-xl text-accent">
                        <i class="fas ${achievement.icon}"></i>
                    </div>
                    <span class="text-xs mt-1">${achievement.name}</span>
                </div>`;
            }).join('');

            return `<div class="screen" id="profileScreen">
                <div class="text-center mb-6">
                    <div class="w-24 h-24 rounded-full overflow-hidden border-4 border-accent mx-auto mb-4 relative">
                        <img id="profileAvatarImg" src="${userData.photoURL}" alt="Profile" class="w-full h-full object-cover">
                        <div class="absolute -bottom-2 -right-2 w-8 h-8 rounded-full bg-card-bg flex items-center justify-center border-2 border-accent text-${ratingTier.color}">
                            <i class="fas ${ratingTier.icon}"></i>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold">${userData.username}</h3>
                        <p class="text-sm font-semibold text-${ratingTier.color}">${ratingTier.name} Tier (${userData.ratingPoints || 0} Points)</p>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3 text-center bg-card-bg p-4 rounded-xl mb-6">
                    <div class="stat-item"><h4 class="text-xl font-bold">${stats.played}</h4><p class="text-xs text-text-secondary">Played</p></div>
                    <div class="stat-item"><h4 class="text-xl font-bold">${stats.won}</h4><p class="text-xs text-text-secondary">Wins</p></div>
                    <div class="stat-item"><h4 class="text-xl font-bold">${winRate}%</h4><p class="text-xs text-text-secondary">Win Rate</p></div>
                </div>
                <div class="bg-card-bg p-4 rounded-xl mb-6">
                    <h4 class="font-semibold mb-4 text-center">Achievements</h4>
                    <div class="grid grid-cols-4 gap-4">${achievementsHtml}</div>
                </div>
                <div class="mb-6"><div class="flex gap-3 items-center"><input type="url" id="photoUrlInput" placeholder="Paste new photo URL" class="flex-1 w-full bg-card-bg border border-white/10 rounded-xl py-3 px-4 text-sm"><button id="updatePhotoBtn" class="bg-accent text-white py-3 px-5 rounded-xl font-semibold cursor-pointer">Save</button></div></div>
                <div class="bg-card-bg rounded-xl p-3 flex items-center gap-4 cursor-pointer mb-3" data-screen="${hasSquad ? 'mySquadScreen' : 'squadsScreen'}"><i class="fas ${hasSquad ? 'fa-shield-alt' : 'fa-users'} text-accent text-2xl w-8 text-center"></i><div class="flex-1"><h4>${hasSquad ? 'View My Squad' : 'No Squad'}</h4><p class="text-xs text-text-secondary">${hasSquad ? 'Click for details' : 'Click to join or create'}</p></div></div>
                <div class="bg-card-bg rounded-xl p-3 flex items-center gap-4 cursor-pointer mb-3" data-screen="duoPartnerScreen"><i class="fas ${hasPartner ? 'fa-user-friends' : 'fa-user'} text-accent text-2xl w-8 text-center"></i><div class="flex-1"><h4>${hasPartner ? 'View Duo Partner' : 'No Duo Partner'}</h4><p class="text-xs text-text-secondary">${hasPartner ? 'Click for details' : 'Click to find a partner'}</p></div></div>
                <div class="bg-card-bg rounded-xl p-3 flex items-center gap-4 cursor-pointer" data-screen="requestsScreen"><i class="fas fa-bell text-accent text-2xl w-8 text-center"></i><div class="flex-1"><h4 class="font-medium">View Requests</h4><p class="text-xs text-text-secondary">Check your pending requests</p></div></div>
                <button id="editProfileBtn" class="w-full text-white py-3 rounded-xl font-semibold mt-6 bg-secondary-bg">EDIT PROFILE</button>
                <button id="logoutBtn" class="w-full text-white py-3 rounded-xl font-semibold mt-3 bg-red-800/50">LOGOUT</button>
            </div>`; 
        },
        menuScreen: () => `<div class="screen" id="menuScreen"><div class="flex flex-col gap-3"><div class="list-item menu-item bg-card-bg p-4 rounded-xl flex items-center gap-4 cursor-pointer" data-screen="leaderboardScreen"><i class="fas fa-trophy w-6 text-center text-accent"></i><span>Leaderboard</span></div><div class="list-item menu-item bg-card-bg p-4 rounded-xl flex items-center gap-4 cursor-pointer" data-screen="noticeScreen"><i class="fas fa-bullhorn w-6 text-center text-accent"></i><span>Notice Board</span></div><div class="list-item menu-item bg-card-bg p-4 rounded-xl flex items-center gap-4 cursor-pointer" data-screen="rulesScreen"><i class="fas fa-gavel w-6 text-center text-accent"></i><span>Rules</span></div><div class="list-item menu-item bg-card-bg p-4 rounded-xl flex items-center gap-4 cursor-pointer" data-screen="guideScreen"><i class="fas fa-book-open w-6 text-center text-accent"></i><span>Guide</span></div><div class="list-item menu-item bg-card-bg p-4 rounded-xl flex items-center gap-4 cursor-pointer" data-screen="contactScreen"><i class="fas fa-headset w-6 text-center text-accent"></i><span>Contact Us</span></div><div class="list-item menu-item bg-card-bg p-4 rounded-xl flex items-center gap-4 cursor-pointer" data-screen="membersScreen"><i class="fas fa-users w-6 text-center text-accent"></i><span>Members</span></div><div class="list-item menu-item bg-card-bg p-4 rounded-xl flex items-center gap-4 cursor-pointer" data-screen="squadsScreen"><i class="fas fa-shield-alt w-6 text-center text-accent"></i><span>Squads</span></div><div class="list-item menu-item bg-card-bg p-4 rounded-xl flex items-center gap-4 cursor-pointer" data-screen="mySquadScreen"><i class="fas fa-user-shield w-6 text-center text-accent"></i><span>My Squad</span></div><div class="list-item menu-item bg-card-bg p-4 rounded-xl flex items-center gap-4 cursor-pointer" data-screen="duoPartnerScreen"><i class="fas fa-user-friends w-6 text-center text-accent"></i><span>Duo Partner</span></div><div class="list-item menu-item bg-card-bg p-4 rounded-xl flex items-center gap-4 cursor-pointer" data-screen="requestsScreen"><i class="fas fa-bell w-6 text-center text-accent"></i><span>Requests</span></div></div></div>`,
        leaderboardScreen: () => `<div class="screen" id="leaderboardScreen"><div id="leaderboardContainer" class="space-y-3"></div></div>`,
        membersScreen: () => `<div class="screen" id="membersScreen"><h3 class="text-lg font-semibold mb-4">All Members</h3><div id="membersListContainer" class="grid grid-cols-2 gap-4"></div></div>`,
        userCard: (user) => {
            const ratingTier = getRatingTier(user.ratingPoints || 0);
            return `<div class="user-card bg-card-bg p-4 rounded-xl text-center cursor-pointer border border-transparent hover:border-accent transition-all" data-user-id="${user.id}">
                <img src="${user.photoURL}" class="w-16 h-16 rounded-full mx-auto mb-3 object-cover border-2 border-secondary-bg">
                <h4 class="font-semibold text-sm">${user.username}</h4>
                <p class="text-xs text-${ratingTier.color}">${ratingTier.name} Tier</p>
            </div>`;
        },
        userDetailsModal: (userData) => {
            const stats = userData.stats || { played: 0, won: 0 };
            const winRate = stats.played > 0 ? ((stats.won / stats.played) * 100).toFixed(1) : 0;
            const ratingTier = getRatingTier(userData.ratingPoints || 0);
            const userAchievements = userData.achievements || [];
            let achievementsHtml = Object.keys(achievementsData).map(key => {
                const isUnlocked = userAchievements.includes(key);
                const achievement = achievementsData[key];
                return `<div class="flex flex-col items-center achievement-badge ${isUnlocked ? 'unlocked' : ''}" title="${achievement.description}">
                    <div class="w-10 h-10 rounded-full bg-primary-bg flex items-center justify-center text-lg text-accent"><i class="fas ${achievement.icon}"></i></div>
                    <span class="text-xs mt-1">${achievement.name}</span>
                </div>`;
            }).join('');

            return `<div id="userDetailsModal" class="modal fixed inset-0 z-[100] bg-black/70 justify-center items-center p-4">
                <div class="modal-content bg-secondary-bg p-6 rounded-2xl w-full max-w-sm max-h-[80vh] overflow-y-auto">
                    <div class="text-center mb-5">
                        <img src="${userData.photoURL}" class="w-20 h-20 rounded-full mx-auto mb-3 object-cover border-4 border-accent">
                        <h3 class="text-xl font-bold">${userData.username}</h3>
                        <p class="text-sm font-semibold text-${ratingTier.color}">${ratingTier.name} Tier (${userData.ratingPoints || 0} Points)</p>
                        <p class="text-xs text-text-secondary">IGN: ${userData.ingameName} | UID: ${userData.ingameUID}</p>
                    </div>
                    <div class="grid grid-cols-3 gap-3 text-center bg-primary-bg p-3 rounded-xl mb-5">
                        <div><h4 class="text-lg font-bold">${stats.played}</h4><p class="text-xs text-text-secondary">Played</p></div>
                        <div><h4 class="text-lg font-bold">${stats.won}</h4><p class="text-xs text-text-secondary">Wins</p></div>
                        <div><h4 class="text-lg font-bold">${winRate}%</h4><p class="text-xs text-text-secondary">Win Rate</p></div>
                    </div>
                    <div class="bg-primary-bg p-4 rounded-xl mb-5">
                        <h4 class="font-semibold mb-3 text-center text-sm">Achievements</h4>
                        <div class="grid grid-cols-4 gap-3">${achievementsHtml}</div>
                    </div>
                    <button type="button" class="close-modal-btn w-full bg-gray-600 text-white py-2 rounded-xl font-semibold mt-2">Close</button>
                </div>
            </div>`;
        },
        squadsScreen: () => `<div class="screen" id="squadsScreen"><h3 class="text-lg font-semibold mb-4">All Squads</h3><div id="squadsListContainer" class="grid grid-cols-2 gap-4"></div></div>`,
        squadCard: (squad) => `<div class="squad-card bg-card-bg p-4 rounded-xl text-center cursor-pointer" data-squad-id="${squad.id}">
            <img src="${squad.logoURL}" class="w-16 h-16 rounded-full mx-auto mb-3 object-cover">
            <h4 class="font-semibold text-sm">${squad.name}</h4>
            <p class="text-xs text-text-secondary">Members: ${(squad.members || []).length}/5</p>
        </div>`,
        squadDetailsModal: (squadData) => {
            if (!squadData) return ui.loading();
            const membersHtml = squadData.memberDetails ? squadData.memberDetails.map(m => `
                <div class="flex items-center gap-3 bg-primary-bg p-2 rounded-lg">
                    <img src="${m.photoURL}" class="w-8 h-8 rounded-full object-cover">
                    <span class="text-sm">${m.username}</span>
                </div>
            `).join('') : '<p class="text-sm text-text-secondary">Loading members...</p>';

            return `<div id="squadDetailsModal" class="modal fixed inset-0 z-[100] bg-black/70 justify-center items-center p-4">
                <div class="modal-content bg-secondary-bg p-6 rounded-2xl w-full max-w-sm max-h-[80vh] overflow-y-auto">
                    <div class="text-center mb-5">
                        <img src="${squadData.logoURL}" class="w-20 h-20 rounded-full mx-auto mb-3 object-cover border-4 border-accent">
                        <h3 class="text-xl font-bold">${squadData.name}</h3>
                        <p class="text-sm text-text-secondary mt-2">${squadData.bio}</p>
                    </div>
                    <h4 class="font-semibold mb-3 text-center text-sm">Members (${(squadData.members || []).length}/5)</h4>
                    <div class="space-y-2 mb-5">${membersHtml}</div>
                    <button type="button" class="close-modal-btn w-full bg-gray-600 text-white py-2 rounded-xl font-semibold mt-2">Close</button>
                </div>
            </div>`;
        },
        mySquadScreen: () => `<div class="screen" id="mySquadScreen"><div id="squadDetailsView" class="hidden"><div class="text-center p-6 bg-card-bg rounded-2xl mb-6"><img id="mySquadLogo" class="w-20 h-20 rounded-full object-cover mx-auto mb-4 border-4 border-accent"><h3 id="mySquadName" class="text-2xl font-bold"></h3><p id="mySquadBio" class="text-text-secondary mt-2 text-sm"></p><p id="squadMemberCount" class="mt-1 text-sm"></p></div><div class="details-actions flex flex-col gap-3 mb-6" id="squadActionsContainer"></div><h3 class="text-lg font-semibold mb-4">Members</h3><div id="mySquadMembersContainer" class="flex flex-col gap-3"></div></div><div id="noSquadView" class="hidden text-center text-text-secondary py-10"><h4 class="font-semibold text-lg">You are not in a squad</h4><p class="text-sm">Join an existing squad or create a new one!</p></div></div>`,
        duoPartnerScreen: () => `<div class="screen" id="duoPartnerScreen"><div id="partnerDetailsView" class="hidden"><div class="text-center p-6 bg-card-bg rounded-2xl mb-6"><img id="myPartnerLogo" class="w-20 h-20 rounded-full object-cover mx-auto mb-4 border-4 border-accent"><h3 id="myPartnerName" class="text-2xl font-bold"></h3></div><h3 class="text-lg font-semibold mb-4">Partner</h3><div id="myPartnerContainer" class="flex flex-col gap-3"></div><div class="flex flex-col gap-3 mt-6" id="partnerActionsContainer"></div></div><div id="noPartnerView" class="hidden"><div class="text-center text-text-secondary py-10"><h4 class="font-semibold text-lg">You don't have a partner</h4><p class="text-sm">Find a partner from the list below!</p></div><h3 class="text-lg font-semibold my-4">Available Players</h3><div id="availablePartnersContainer" class="flex flex-col gap-3"></div></div></div>`,
        requestsScreen: () => `<div class="screen" id="requestsScreen"><h3 class="text-lg font-semibold mb-4">Your Requests</h3><div class="flex mb-5 border-b border-white/10"><button class="tab-btn active flex-1 py-2 text-sm font-medium border-b-2" data-tab="received">Received</button><button class="tab-btn flex-1 py-2 text-sm font-medium border-b-2 border-transparent text-text-secondary" data-tab="sent">Sent</button></div><div class="tab-container"><div id="receivedTab" class="tab-content"><div id="receivedRequestsContainer" class="flex flex-col gap-3"></div></div><div id="sentTab" class="tab-content hidden"><div id="sentRequestsContainer" class="flex flex-col gap-3"></div></div></div></div>`,
        tournamentsScreen: (type) => `<div class="screen" id="${type}TournamentsScreen"><h3 class="text-lg font-semibold mb-4 capitalize">${type} Tournaments</h3><div id="${type}TournamentsContainer" class="flex flex-col gap-4"></div></div>`,
        tournamentResultScreen: () => `<div class="screen" id="tournamentResultScreen"><h3 class="text-lg font-semibold mb-4">Match Results</h3><div id="tournamentResultContainer" class="space-y-4"></div></div>`,
        qualifyGroupsScreen: () => `<div class="screen" id="qualifyGroupsScreen"><h3 class="text-lg font-semibold mb-4">Qualified Groups</h3><div id="qualifyGroupsContainer" class="space-y-3"></div></div>`,
        chatScreen: () => `<div class="screen" id="chatScreen"><div class="flex flex-col h-[calc(100vh-8rem)]"><div id="chatMessagesContainer" class="flex-1 overflow-y-auto p-3 flex flex-col gap-2.5"></div><form id="chatForm" class="flex p-3 border-t border-white/10 items-center"><input type="text" id="chatMessageInput" placeholder="Type a message..." class="flex-1 bg-card-bg border-none py-3 px-5 rounded-full text-white text-sm focus:ring-2 focus:ring-accent outline-none"><button type="submit" id="chatSendBtn" class="bg-none border-none text-accent text-2xl ml-3 h-10 w-10 flex items-center justify-center"><i class="fas fa-paper-plane"></i></button></form></div></div>`,
        walletScreen: (userData) => `<div class="screen" id="walletScreen"><div class="bg-card-bg p-6 rounded-2xl text-center mb-6"><h4 class="text-sm text-text-secondary mb-2">Current Balance</h4><h2 class="text-4xl font-bold">৳ ${userData?.balance || 0}</h2></div><div class="grid grid-cols-2 gap-4 mb-6"><button id="addTakaBtn" class="w-full bg-accent text-white py-3 rounded-xl font-semibold">Add Taka</button><button id="withdrawTakaBtn" class="w-full bg-secondary-bg text-white py-3 rounded-xl font-semibold">Withdraw</button></div><div class="mt-6"><h3 class="text-lg font-semibold mb-4">Transaction History</h3><div id="transactionHistory" class="space-y-3"><p class="text-sm text-center text-text-secondary">No transactions yet.</p></div></div></div>`,
        noticeScreen: () => `<div class="screen" id="noticeScreen"><div id="noticeContainer" class="space-y-4"></div></div>`,
        rulesScreen: () => `<div class="screen" id="rulesScreen"><div id="rulesContainer" class="bg-card-bg p-5 rounded-lg whitespace-pre-wrap text-text-secondary leading-relaxed"></div></div>`,
        guideScreen: () => `<div class="screen" id="guideScreen"><a href="https://postimages.org/" target="_blank" class="bg-card-bg p-4 rounded-xl flex items-center gap-4 mb-4"><i class="fas fa-link w-6 text-center text-accent text-2xl"></i><div><h4 class="font-bold">Image to Link Converter</h4><p class="text-xs text-text-secondary">Click here to upload photos and get links.</p></div></a><div class="bg-card-bg p-4 rounded-xl mb-6"><h4 class="font-bold mb-3">Contact Us</h4><div class="space-y-2 text-sm"><div class="flex items-center gap-3"><i class="fab fa-tiktok w-5 text-center"></i><span>@touritionhub</span></div><div class="flex items-center gap-3"><i class="fab fa-facebook w-5 text-center"></i><span>@nayeemplayz180</span></div></div></div><div id="guidesContainer" class="space-y-4"></div></div>`,
        contactScreen: () => `<div class="screen" id="contactScreen"><div id="contactContainer" class="space-y-4"></div></div>`,
        createSquadModal: () => `<div id="createSquadModal" class="modal fixed inset-0 z-[100] bg-black/70 justify-center items-center"><div class="modal-content bg-secondary-bg p-6 rounded-2xl w-11/12 max-w-sm"><h3 class="text-xl font-bold mb-5 text-center">Create a New Squad</h3><form id="createSquadForm"><div class="mb-4"><input type="text" id="squadNameInput" placeholder="Squad Name" required class="w-full bg-card-bg border border-white/10 rounded-xl py-3 px-4 text-sm"></div><div class="mb-4"><input type="url" id="squadLogoUrlInput" placeholder="Squad Logo URL" required class="w-full bg-card-bg border border-white/10 rounded-xl py-3 px-4 text-sm"></div><div class="mb-4"><textarea id="squadBioInput" placeholder="Squad Bio" rows="3" required class="w-full bg-card-bg border border-white/10 rounded-xl py-3 px-4 text-sm"></textarea></div><button type="submit" class="w-full bg-accent text-white py-3 rounded-xl font-semibold">Create Squad</button><button type="button" class="close-modal-btn w-full bg-gray-600 text-white py-3 rounded-xl font-semibold mt-2">Cancel</button></form></div></div>`,
        editProfileModal: (userData) => `<div id="editProfileModal" class="modal fixed inset-0 z-[100] bg-black/70 justify-center items-center"><div class="modal-content bg-secondary-bg p-6 rounded-2xl w-11/12 max-w-sm"><h3 class="text-xl font-bold mb-5 text-center">Edit Profile</h3><form id="editProfileForm"><div class="mb-4"><label class="text-xs text-text-secondary">Username</label><input type="text" id="editUsername" required class="w-full bg-card-bg border border-white/10 rounded-xl py-3 px-4 text-sm" value="${userData.username || ''}"></div><div class="mb-4"><label class="text-xs text-text-secondary">In-Game Name</label><input type="text" id="editIngameName" required class="w-full bg-card-bg border border-white/10 rounded-xl py-3 px-4 text-sm" value="${userData.ingameName || ''}"></div><div class="mb-4"><label class="text-xs text-text-secondary">In-Game UID</label><input type="text" id="editIngameUID" required class="w-full bg-card-bg border border-white/10 rounded-xl py-3 px-4 text-sm" value="${userData.ingameUID || ''}"></div><div class="flex gap-3 mt-5"><button type="submit" class="flex-1 bg-accent text-white py-3 rounded-xl font-semibold">Save</button><button type="button" class="close-modal-btn flex-1 bg-gray-600 text-white py-3 rounded-xl font-semibold">Cancel</button></div></form></div></div>`,
        detailsModal: (data) => `<div class="modal fixed inset-0 z-[100] bg-black/70 justify-center items-center p-4"><div id="detailsModalContent" class="modal-content bg-secondary-bg p-6 rounded-2xl w-full max-w-sm max-h-[80vh] overflow-y-auto"><h3 class="text-xl font-bold mb-2">${data.tournament.name}</h3><p class="text-sm text-text-secondary mb-4">Status: <span class="font-semibold ${data.tournament.status === 'live' ? 'text-green-400' : 'text-yellow-400'}">${data.tournament.status}</span></p><div class="space-y-3 text-sm border-t border-b border-white/10 py-4 mb-4"><p><strong>Prize Pool:</strong> ৳${data.tournament.prize}</p><p><strong>Entry Fee:</strong> ৳${data.tournament.entryFee}</p><p><strong>Slots:</strong> ${data.tournament.registeredCount || 0} / ${data.tournament.maxPlayers}</p></div>${(data.tournament.liveStreamUrl || data.tournament.bracketUrl) ? `<div class="flex gap-2 mb-4">${data.tournament.liveStreamUrl ? `<a href="${data.tournament.liveStreamUrl}" target="_blank" class="flex-1 text-center bg-red-600 text-white py-2 rounded-lg text-sm font-semibold">Watch Live</a>` : ''}${data.tournament.bracketUrl ? `<a href="${data.tournament.bracketUrl}" target="_blank" class="flex-1 text-center bg-blue-600 text-white py-2 rounded-lg text-sm font-semibold">View Bracket</a>` : ''}</div>` : ''}<h4 class="font-semibold mb-2">Details</h4><p class="text-sm text-text-secondary mb-4 whitespace-pre-wrap">${data.tournament.details}</p><h4 class="font-semibold mb-2">Notice</h4><p class="text-sm text-text-secondary mb-6 whitespace-pre-wrap">${data.tournament.notice}</p><div class="flex gap-2"><button class="close-modal-btn flex-1 bg-gray-600 text-white py-3 rounded-xl font-semibold">Close</button></div></div></div>`,
        inviteUserModal: () => `<div id="inviteUserModal" class="modal fixed inset-0 z-[100] bg-black/70 justify-center items-center"><div class="modal-content bg-secondary-bg p-6 rounded-2xl w-11/12 max-w-sm flex flex-col h-3/4"><h3 class="text-xl font-bold mb-5 text-center">Invite Members</h3><div id="inviteUserList" class="flex-1 overflow-y-auto pr-2"></div><div class="flex gap-3 mt-5"><button id="sendInvitesBtn" class="flex-1 bg-accent text-white py-3 rounded-xl font-semibold">Send Invites</button><button type="button" class="close-modal-btn flex-1 bg-gray-600 text-white py-3 rounded-xl font-semibold">Cancel</button></div></div></div>`,
        addTakaModal: () => `<div id="addTakaModal" class="modal fixed inset-0 z-[100] bg-black/70 justify-center items-center"><div class="modal-content bg-secondary-bg p-6 rounded-2xl w-11/12 max-w-sm"><h3 class="text-xl font-bold mb-5 text-center">Add Balance</h3><div class="bg-card-bg p-4 rounded-lg mb-4 text-center"><p class="font-bold text-lg">01731143459</p><p class="text-xs text-text-secondary">[এই নাম্বারে বিকাশ বা নগদে টাকা পাঠিয়ে নিচের ফর্ম পূরণ করুন]</p></div><form id="addTakaForm" class="space-y-4"><div><label>Amount</label><input type="number" id="takaAmount" placeholder="e.g., 50" required class="w-full bg-card-bg border border-white/10 rounded-xl py-3 px-4 text-sm"></div><div><label>Method</label><select id="takaMethod" class="w-full bg-card-bg border border-white/10 rounded-xl py-3 px-4 text-sm"><option>Bikash</option><option>Nagad</option></select></div><div><label>Your Bikash/Nagad Number</label><input type="tel" id="takaNumber" placeholder="e.g., 01xxxxxxxxx" required class="w-full bg-card-bg border border-white/10 rounded-xl py-3 px-4 text-sm"></div><div><label>Transaction ID</label><input type="text" id="takaTrxId" placeholder="Your transaction ID" required class="w-full bg-card-bg border border-white/10 rounded-xl py-3 px-4 text-sm"></div><div class="text-xs text-yellow-400 mt-2"><p><strong>সতর্কতা:</strong> ভুল ট্রানজেকশন আইডি দিলে আপনার অনুরোধ বাতিল করা হবে এবং আপনার অ্যাকাউন্ট ব্যান করা হতে পারে।</p></div><div class="flex gap-3 pt-4"><button type="submit" class="flex-1 bg-accent text-white py-3 rounded-xl font-semibold">Request</button><button type="button" class="close-modal-btn flex-1 bg-gray-600 text-white py-3 rounded-xl font-semibold">Cancel</button></div></form></div></div>`,
        withdrawTakaModal: (balance) => `<div id="withdrawTakaModal" class="modal fixed inset-0 z-[100] bg-black/70 justify-center items-center"><div class="modal-content bg-secondary-bg p-6 rounded-2xl w-11/12 max-w-sm"><h3 class="text-xl font-bold mb-5 text-center">Request Withdrawal</h3><p class="text-center text-sm mb-4">Available Balance: <span class="font-bold">৳${balance}</span></p><form id="withdrawTakaForm" class="space-y-4"><div><label>Amount</label><input type="number" id="withdrawAmount" placeholder="e.g., 100" required class="w-full bg-card-bg border border-white/10 rounded-xl py-3 px-4 text-sm" max="${balance}"></div><div><label>Method</label><select id="withdrawMethod" class="w-full bg-card-bg border border-white/10 rounded-xl py-3 px-4 text-sm"><option>Bikash</option><option>Nagad</option></select></div><div><label>Your Bikash/Nagad Number</label><input type="tel" id="withdrawNumber" placeholder="e.g., 01xxxxxxxxx" required class="w-full bg-card-bg border border-white/10 rounded-xl py-3 px-4 text-sm"></div><div class="flex gap-3 pt-4"><button type="submit" class="flex-1 bg-accent text-white py-3 rounded-xl font-semibold">Submit Request</button><button type="button" class="close-modal-btn flex-1 bg-gray-600 text-white py-3 rounded-xl font-semibold">Cancel</button></div></form></div></div>`,
        welcomeModal: (data) => `<div id="welcomeModal" class="modal fixed inset-0 z-[100] bg-black/70 justify-center items-center p-4"><div class="modal-content bg-secondary-bg p-6 rounded-2xl w-full max-w-sm"><h3 class="text-xl font-bold mb-4 text-center">${data.title}</h3>${data.imageUrl ? `<img src="${data.imageUrl}" class="w-full rounded-lg mb-4 max-h-40 object-cover">` : ''}${data.videoUrl ? `<div class="aspect-w-16 aspect-h-9 mb-4"><iframe src="${data.videoUrl.replace('watch?v=', 'embed/')}" frameborder="0" allowfullscreen class="w-full h-full rounded-lg"></iframe></div>` : ''}<p class="text-sm text-text-secondary mb-6 whitespace-pre-wrap">${data.content}</p><button id="welcomeGoToGuideBtn" class="w-full bg-accent text-white py-3 rounded-xl font-semibold">Go to Guide Page</button><button type="button" class="close-modal-btn w-full bg-gray-600 text-white py-3 rounded-xl font-semibold mt-2">Close</button></div></div>`,
        transactionItem: (trx) => { const isCredit = trx.amount > 0; return `<div class="bg-card-bg p-3 rounded-lg flex justify-between items-center"><div class="flex-1"><p class="font-medium text-sm">${trx.description}</p><p class="text-xs text-text-secondary">${new Date(trx.timestamp.seconds * 1000).toLocaleString()}</p></div><p class="font-bold ${isCredit ? 'text-green-400' : 'text-red-400'}">${isCredit ? '+' : '-'} ৳ ${Math.abs(trx.amount)}</p></div>`; },
        tournamentCard: (tournament, type) => { const isRegistered = state.currentUserData && tournament.registrations && (tournament.registrations[state.currentUserData.id] || tournament.registrations[state.currentUserData.squadId] || tournament.registrations[state.currentUserData.partnerId]); const card = document.createElement('div'); card.className = 'bg-card-bg rounded-xl overflow-hidden shadow-lg'; card.innerHTML = `<div class="tournament-card-clickable cursor-pointer" data-tournament-id="${tournament.id}" data-type="${type}"><img src="${tournament.bannerUrl}" class="w-full h-40 object-cover" alt="${tournament.name}"><div class="p-4"><div class="flex justify-between items-start mb-3"><div><h3 class="font-bold text-lg">${tournament.name}</h3><p class="text-accent font-semibold">Prize: ৳${tournament.prize}</p></div><div class="flex flex-col items-end gap-1"><span class="text-xs font-medium capitalize px-2 py-1 rounded-md ${tournament.status === 'live' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}">${tournament.status}</span><span class="text-xs font-medium capitalize px-2 py-1 rounded-md bg-indigo-500/20 text-indigo-400">${tournament.format || 'Classic'}</span></div></div><div class="flex justify-between text-xs text-text-secondary"><span>Entry: ৳${tournament.entryFee}</span><span>Slots: ${tournament.registeredCount || 0}/${tournament.maxPlayers}</span></div></div></div><div class="p-4 pt-0">${isRegistered ? `<div class="flex gap-2 text-center"><button class="tournament-chat-btn flex-1 bg-cyan-500 text-white py-2 rounded-lg text-xs font-semibold" data-tournament-id="${tournament.id}" data-type="${type}">Chat</button><button class="result-btn flex-1 bg-indigo-500 text-white py-2 rounded-lg text-xs font-semibold" data-tournament-id="${tournament.id}" data-type="${type}">Result</button><button class="qualify-btn flex-1 bg-purple-500 text-white py-2 rounded-lg text-xs font-semibold" data-tournament-id="${tournament.id}" data-type="${type}">Qualify</button></div>` : `<button class="join-btn w-full bg-accent text-white py-2 rounded-lg text-sm font-semibold" data-tournament-id="${tournament.id}" data-type="${type}">Join</button>`}</div>`; return card; },
        newsItem: (news) => `<div class="bg-card-bg rounded-xl p-3 flex items-center gap-4 cursor-pointer" data-news-title="${news.title}" data-news-content="${news.content}"><div class="w-12 h-12 bg-secondary-bg rounded-lg flex items-center justify-center text-accent"><i class="fas fa-newspaper text-xl"></i></div><div class="flex-1"><h4 class="font-semibold text-sm">${news.title}</h4><p class="text-xs text-text-secondary">${news.content.substring(0, 40)}...</p></div></div>`,
        noticeItem: (notice) => `<div class="bg-card-bg rounded-xl p-4"><h3 class="font-bold text-lg mb-2 text-accent">${notice.title}</h3><p class="text-sm text-text-secondary whitespace-pre-wrap">${notice.content}</p></div>`,
        guideItem: (guide) => `<div class="bg-card-bg rounded-xl overflow-hidden mb-4"><img src="${guide.imageUrl}" class="w-full h-40 object-cover" alt="${guide.title}"><div class="p-4"><h3 class="font-bold text-lg mb-2">${guide.title}</h3>${guide.videoUrl ? `<div class="aspect-w-16 aspect-h-9 my-4"><iframe src="${guide.videoUrl.replace('watch?v=', 'embed/')}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-full rounded-lg"></iframe></div>` : ''}<p class="text-sm text-text-secondary whitespace-pre-wrap mb-4">${guide.description}</p>${(guide.columns || []).map(col => `<div class="mt-4"><img src="${col.imageUrl}" class="w-full rounded-lg mb-2"><p class="text-sm text-text-secondary whitespace-pre-wrap">${col.description}</p></div>`).join('')}</div></div>`,
        contactItem: (item) => `<div class="bg-card-bg rounded-xl overflow-hidden mb-4">${item.imageUrl ? `<img src="${item.imageUrl}" class="w-full h-40 object-cover" alt="${item.title}">` : ''}<div class="p-4"><h3 class="font-bold text-lg mb-2">${item.title}</h3>${item.videoUrl ? `<div class="aspect-w-16 aspect-h-9 my-4"><iframe src="${item.videoUrl.replace('watch?v=', 'embed/')}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-full rounded-lg"></iframe></div>` : ''}<p class="text-sm text-text-secondary whitespace-pre-wrap mb-4">${item.description}</p></div></div>`,
        squadMemberListItem: (member, adminId) => { const isCurrentUserAdmin = state.currentUser.uid === adminId; const isThisMemberAdmin = member.id === adminId; let buttonHtml = ''; if (isCurrentUserAdmin && !isThisMemberAdmin) { buttonHtml = `<button class="kick-member-btn text-xs bg-danger text-white py-1.5 px-3 rounded-md" data-member-id="${member.id}">Kick</button>`; } return `<div class="bg-card-bg rounded-xl p-3 flex items-center justify-between gap-4"><div class="flex items-center gap-3"><img src="${member.photoURL}" class="w-10 h-10 rounded-full object-cover"><div class="flex-1"><h4 class="font-medium text-sm">${member.username} ${isThisMemberAdmin ? '<span class="text-accent text-xs">(Admin)</span>' : ''}</h4><p class="text-xs text-text-secondary">${member.ingameName || ''}</p></div></div> ${buttonHtml}</div>`; },
        userListItem: (user, options = {}) => { const el = document.createElement('div'); el.className = 'bg-card-bg rounded-xl p-3 flex items-center justify-between gap-4'; let buttonHtml = ''; if (options.showInviteButton) { buttonHtml = `<button class="invite-partner-btn text-xs bg-accent text-white py-1.5 px-3 rounded-md" data-user-id="${user.id}">Invite</button>`; } el.innerHTML = `<div class="flex items-center gap-3"><img src="${user.photoURL}" class="w-10 h-10 rounded-full object-cover"><div class="flex-1"><h4 class="font-medium text-sm">${user.username}</h4><p class="text-xs text-text-secondary">${user.ingameName || ''}</p></div></div> ${buttonHtml}`; return el; },
        squadListItem: (squad) => `<div class="bg-card-bg rounded-xl p-3 flex items-center justify-between gap-4"><div class="flex items-center gap-3"><img src="${squad.logoURL}" class="w-10 h-10 rounded-full object-cover"><div><h4 class="font-medium text-sm">${squad.name}</h4><p class="text-xs text-text-secondary">Members: ${(squad.members || []).length}/5</p></div></div> ${squad.members.length < 5 && !state.currentUserData.squadId ? `<button class="join-squad-btn text-xs bg-accent text-white py-1.5 px-3 rounded-md" data-squad-id="${squad.id}" data-squad-name="${squad.name}" data-admin-id="${squad.adminId}">Join</button>` : ''}</div>`,
        requestItem: (req, perspective) => {
            let message = '';
            if (req.type === 'squad_invite') message = `<strong>${req.fromUserName}</strong> invited you to join <strong>${req.squadName}</strong>.`;
            else if (req.type === 'squad_join') message = `<strong>${req.fromUserName}</strong> wants to join your squad <strong>${req.squadName || ''}</strong>.`;
            else if (req.type === 'partner_request') message = `<strong>${req.fromUserName}</strong> wants to be your duo partner.`;
            const buttons = perspective === 'received' ? `<div class="flex gap-2"><button class="accept-btn flex-1 text-xs bg-success text-white py-2 px-3 rounded-md" data-req-id="${req.id}">Accept</button><button class="reject-btn flex-1 text-xs bg-danger text-white py-2 px-3 rounded-md" data-req-id="${req.id}">Reject</button></div>` : `<div class="flex gap-2"><button class="cancel-btn flex-1 text-xs bg-warning text-white py-2 px-3 rounded-md" data-req-id="${req.id}">Cancel</button></div>`;
            return `<div class="bg-card-bg p-4 rounded-xl" data-req-data='${JSON.stringify(req)}'><p class="text-sm mb-3">${message}</p>${buttons}</div>`;
        },
        chatMessageItem: (msg) => {
            const isSentByMe = msg.senderId === state.currentUser.uid; const isSystem = msg.senderId === 'system';
            const textContent = msg.text.replace(/\[img\](https?:\/\/[^\s]+)\[\/img\]/g, `<img src="$1" class="rounded-lg mt-2 max-w-full" alt="Image from chat">`);
            if(isSystem) return `<div class="self-center text-xs text-center text-text-secondary bg-secondary-bg/50 px-3 py-1 rounded-full my-2 chat-message-text">${textContent}</div>`;
            return `<div class="flex flex-col ${isSentByMe ? 'items-end' : 'items-start'}"><div class="p-2.5 rounded-lg max-w-[70%] ${isSentByMe ? 'bg-accent text-white rounded-br-none' : 'bg-card-bg rounded-bl-none'}">${!isSentByMe ? `<div class="text-xs text-accent font-semibold mb-1">${msg.senderName}</div>` : ''}<div class="chat-message-text">${textContent}</div></div></div>`;
        },
        updateCard: (data) => {
            const detailsHtml = (data.details || '').split('\\n').map(line => `<li class="text-sm text-text-secondary">${line.trim()}</li>`).join('');
            return `<div class="bg-card-bg rounded-xl p-4">
                        <div class="flex justify-between items-center mb-2">
                           <h4 class="font-bold text-lg">New Version Available! <span class="text-accent">${data.version}</span></h4>
                           <span class="text-xs bg-secondary-bg px-2 py-1 rounded">Your Version: ${currentAppVersion}</span>
                        </div>
                        <ul class="list-disc list-inside space-y-1 mb-4">${detailsHtml}</ul>
                        <a href="${data.downloadUrl}" target="_blank" class="w-full inline-block text-center bg-accent text-white py-2 rounded-lg text-sm font-semibold">Update Now</a>
                    </div>`;
        },
      };
      
      const services = {
          registerUser: async (username, ingameName, ingameUID, email, password) => { try { const userCredential = await createUserWithEmailAndPassword(auth, email, password); const defaultPhoto = "https://firebasestorage.googleapis.com/v0/b/e-sports-24ac6.appspot.com/o/default-avatar.png?alt=media&token=571c3395-3023-4876-888a-21f4340d8905"; await updateProfile(userCredential.user, { displayName: username, photoURL: defaultPhoto }); await setDoc(doc(db, "users", userCredential.user.uid), { username, email, ingameName, ingameUID, photoURL: defaultPhoto, squadId: null, partnerId: null, createdAt: serverTimestamp(), balance: 0, hasSeenWelcomePopup: false, stats: { played: 0, won: 0 }, ratingPoints: 0, achievements: [] }); } catch (error) { alert(`Registration failed: ${error.message}`); throw error; } },
          loginUser: (email, password) => signInWithEmailAndPassword(auth, email, password),
          logoutUser: () => signOut(auth),
          resetPassword: (email) => sendPasswordResetEmail(auth, email),
          createWithdrawRequest: (data) => addDoc(collection(db, 'withdrawalRequests'), { ...data, userId: state.currentUser.uid, username: state.currentUserData.username, status: 'pending', createdAt: serverTimestamp() }),
          listenToUserData: (userId, callback) => onSnapshot(doc(db, 'users', userId), (docSnap) => callback(docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null)),
          listenToBanner: (callback) => onSnapshot(doc(db, 'app', 'banner'), (docSnap) => callback(docSnap.exists() ? docSnap.data() : null)),
          listenToNews: (callback) => { const q = query(collection(db, "news"), orderBy("createdAt", "desc"), limit(3)); return onSnapshot(q, snap => callback(snap.docs.map(d => ({id: d.id, ...d.data()})))); },
          listenToDocument: (collectionName, docId, callback) => onSnapshot(doc(db, collectionName, docId), (docSnap) => callback(docSnap.exists() ? docSnap.data() : null)),
          listenToCollection: (collectionName, callback, order = 'desc') => { const q = query(collection(db, collectionName), orderBy('createdAt', order)); return onSnapshot(q, snap => callback(snap.docs.map(d => ({id: d.id, ...d.data()})))); },
          listenToSubCollection: (path, callback) => { const q = query(collection(db, path), orderBy('createdAt', 'desc')); return onSnapshot(q, snap => callback(snap.docs.map(d => ({id: d.id, ...d.data()})))); },
          listenToTransactions: (userId, callback) => { const q = query(collection(db, 'users', userId, 'transactions'), orderBy('timestamp', 'desc'), limit(20)); return onSnapshot(q, snap => callback(snap.docs.map(d => d.data()))); },
          listenToTournaments: (type, callback) => { const q = query(collection(db, 'tournaments', type, 'items'), orderBy('createdAt', 'desc')); return onSnapshot(q, snap => callback(snap.docs.map(d => ({id: d.id, ...d.data()})))); },
          listenToList: (collectionName, callback) => { const q = query(collection(db, collectionName)); return onSnapshot(q, snap => callback(snap.docs.map(d => ({id: d.id, ...d.data()})))); },
          getSquadDetails: async (squadId) => { const squadSnap = await getDoc(doc(db, 'squads', squadId)); if (!squadSnap.exists()) { return null; } const squadData = {id: squadSnap.id, ...squadSnap.data()}; const memberPromises = (squadData.members || []).map(id => getDoc(doc(db, 'users', id))); const memberDocs = await Promise.all(memberPromises); squadData.memberDetails = memberDocs.map(d => d.exists() ? {id: d.id, ...d.data()} : null).filter(Boolean); return squadData; },
          listenToSquadDetails: (squadId, callback) => onSnapshot(doc(db, 'squads', squadId), async (squadSnap) => { if (!squadSnap.exists()) { callback(null); return; } const squadData = {id: squadSnap.id, ...squadSnap.data()}; const memberPromises = (squadData.members || []).map(id => getDoc(doc(db, 'users', id))); const memberDocs = await Promise.all(memberPromises); squadData.memberDetails = memberDocs.map(d => d.exists() ? {id: d.id, ...d.data()} : null).filter(Boolean); callback(squadData); }),
          listenToPartnerDetails: (partnerId, callback) => onSnapshot(doc(db, 'partners', partnerId), async (partnerSnap) => { if (!partnerSnap.exists()) { callback(null); return; } const partnerData = {id: partnerSnap.id, ...partnerSnap.data()}; const partnerUserId = partnerData.members.find(id => id !== state.currentUser.uid); if(partnerUserId) { const userDoc = await getDoc(doc(db, 'users', partnerUserId)); if(userDoc.exists()) { partnerData.partnerInfo = {id: userDoc.id, ...userDoc.data()}; } } callback(partnerData); }),
          listenToAvailablePartners: (callback) => { const q = query(collection(db, 'users'), where('partnerId', '==', null)); return onSnapshot(q, snap => callback(snap.docs.map(d => ({id: d.id, ...d.data()})).filter(u => u.id !== state.currentUser.uid))); },
          listenToRequests: (type, callback) => { const field = type === 'received' ? 'toUserId' : 'fromUserId'; const q = query(collection(db, 'requests'), where(field, '==', state.currentUser.uid), where('status', '==', 'pending')); return onSnapshot(q, snap => callback(snap.docs.map(d => ({id: d.id, ...d.data()})))); },
          listenToChatMessages: (chatId, callback) => { const q = query(collection(db, 'chats', chatId, 'messages'), orderBy('timestamp', 'asc')); return onSnapshot(q, snap => callback(snap.docs.map(d => d.data()))); },
          listenToAppUpdate: (callback) => onSnapshot(doc(db, 'app', 'update'), (docSnap) => callback(docSnap.exists() ? docSnap.data() : null)),
          getUsers: async (queryConstraints = []) => { const q = query(collection(db, 'users'), ...queryConstraints); const snapshot = await getDocs(q); return snapshot.docs.map(d => ({id: d.id, ...d.data()})); },
          updateUserProfile: async (username, ingameName, ingameUID) => { await updateDoc(doc(db, "users", state.currentUser.uid), { username, ingameName, ingameUID }); if(auth.currentUser.displayName !== username) await updateProfile(auth.currentUser, { displayName: username }); },
          updateUserPhoto: async (newUrl) => { await updateDoc(doc(db, "users", state.currentUser.uid), { photoURL: newUrl }); await updateProfile(auth.currentUser, { photoURL: newUrl }); },
          createSquad: async (name, logoURL, bio) => { const teamRef = await addDoc(collection(db, 'squads'), { name, logoURL, bio, adminId: state.currentUserData.id, members: [state.currentUserData.id], createdAt: serverTimestamp() }); await updateDoc(doc(db, "users", state.currentUserData.id), { squadId: teamRef.id }); },
          sendRequest: async (type, toUserId, extraData = {}) => { const fromUserId = state.currentUserData.id; const q = query(collection(db, 'requests'), where('type', '==', type), where('fromUserId', '==', fromUserId), where('toUserId', '==', toUserId), where('status', '==', 'pending')); const existing = await getDocs(q); if (!existing.empty) throw new Error('Request already sent.'); await addDoc(collection(db, 'requests'), { type, fromUserId, toUserId, status: 'pending', fromUserName: state.currentUserData.username, createdAt: serverTimestamp(), ...extraData }); },
          createTakaRequest: (data) => addDoc(collection(db, 'takaRequests'), { ...data, userId: state.currentUser.uid, username: state.currentUserData.username, status: 'pending', createdAt: serverTimestamp() }),
          registerForTournament: async (tournamentId, type) => {
                if (type === 'duo' && !state.currentUserData.partnerId) throw new Error('You must have a duo partner to join.'); if (type === 'squad' && !state.currentUserData.squadId) throw new Error('You must be in a squad to join.');
                const tournamentRef = doc(db, 'tournaments', type, 'items', tournamentId);
                const userRef = doc(db, 'users', state.currentUser.uid);

                await runTransaction(db, async (t) => {
                    const tDoc = await t.get(tournamentRef);
                    const userDoc = await t.get(userRef);
                    if (!tDoc.exists()) throw new Error("Tournament not found!");
                    if (!userDoc.exists()) throw new Error("User not found!");

                    const tournamentData = tDoc.data();
                    const userData = userDoc.data();
                    const entryFee = tournamentData.entryFee || 0;

                    if (userData.balance < entryFee) throw new Error("Insufficient balance.");
                    if ((tournamentData.registeredCount || 0) >= tournamentData.maxPlayers) throw new Error("Tournament is full!");
                    let regId = {'solo': state.currentUserData.id, 'duo': state.currentUserData.partnerId, 'squad': state.currentUserData.squadId}[type];
                    if(tournamentData.registrations && tournamentData.registrations[regId]) throw new Error("Already registered!");

                    const newBalance = userData.balance - entryFee;
                    t.update(userRef, { balance: newBalance });
                    t.set(doc(collection(db, 'users', state.currentUser.uid, 'transactions')), { amount: -entryFee, description: `Entry Fee: ${tournamentData.name}`, timestamp: serverTimestamp() });
                    t.update(tournamentRef, { [`registrations.${regId}`]: { registeredBy: state.currentUserData.id, at: serverTimestamp() }, registeredCount: (tournamentData.registeredCount || 0) + 1 });
                });

                let systemMessage = '';
                if (type === 'solo') { systemMessage = `Player "${state.currentUserData.ingameName}" (UID: ${state.currentUserData.ingameUID}) has registered.`; } 
                else if (type === 'duo') { const partnerDoc = await getDoc(doc(db, 'partners', state.currentUserData.partnerId)); if (partnerDoc.exists()) { const partnerData = partnerDoc.data(); const memberDocs = await Promise.all(partnerData.members.map(id => getDoc(doc(db, 'users', id)))); const membersInfo = memberDocs.map(d => d.data()); const membersList = membersInfo.map(m => `- ${m.ingameName} (UID: ${m.ingameUID})`).join('\n'); systemMessage = `Duo Team "${partnerData.name}" has registered.\n\nPartners:\n${membersList}`; } } 
                else if (type === 'squad') { const squadDoc = await getDoc(doc(db, 'squads', state.currentUserData.squadId)); if (squadDoc.exists()) { const squadData = squadDoc.data(); const memberDocs = await Promise.all((squadData.members || []).map(id => getDoc(doc(db, 'users', id)))); const membersInfo = memberDocs.map(d => d.data()); const membersList = membersInfo.map(m => `- ${m.ingameName} (UID: ${m.ingameUID})`).join('\n'); systemMessage = `Squad "${squadData.name}" has registered.\nLogo: ${squadData.logoURL}\n\nMembers:\n${membersList}`; } }
                if(systemMessage) await services.sendChatMessage(`${type}_${tournamentId}`, systemMessage, true);
          },
          deleteRequest: (reqId) => deleteDoc(doc(db, 'requests', reqId)),
          sendChatMessage: (chatId, text, isSystem = false) => addDoc(collection(db, 'chats', chatId, 'messages'), { text, senderId: isSystem ? 'system' : state.currentUser.uid, senderName: isSystem ? 'System Bot' : state.currentUserData.username, timestamp: serverTimestamp() }),
          handleRequestResponse: async (req, accepted) => {
                const batch = writeBatch(db); const reqRef = doc(db, 'requests', req.id);
                if (!accepted) { batch.update(reqRef, { status: 'rejected' }); await batch.commit(); alert('Request rejected.'); return; }
                if (req.type === 'squad_invite') { if (state.currentUserData.squadId) throw new Error("You are already in a squad."); batch.update(doc(db, 'squads', req.squadId), { members: arrayUnion(req.toUserId) }); batch.update(doc(db, 'users', req.toUserId), { squadId: req.squadId });
                } else if (req.type === 'squad_join') { const senderUserDoc = await getDoc(doc(db, 'users', req.fromUserId)); if (senderUserDoc.data().squadId) throw new Error("This user is already in a squad."); batch.update(doc(db, 'squads', req.squadId), { members: arrayUnion(req.fromUserId) }); batch.update(doc(db, 'users', req.fromUserId), { squadId: req.squadId });
                } else if (req.type === 'partner_request') { if (state.currentUserData.partnerId) throw new Error("You already have a partner."); const senderUserDoc = await getDoc(doc(db, 'users', req.fromUserId)); if (senderUserDoc.data().partnerId) throw new Error("This user already has a partner."); const partnerDocRef = doc(collection(db, 'partners')); batch.set(partnerDocRef, { name: `${req.fromUserName} & ${state.currentUserData.username}`, members: [req.fromUserId, req.toUserId], adminId: req.fromUserId, createdAt: serverTimestamp() }); batch.update(doc(db, 'users', req.fromUserId), { partnerId: partnerDocRef.id }); batch.update(doc(db, 'users', req.toUserId), { partnerId: partnerDocRef.id }); }
                batch.update(reqRef, { status: 'accepted' }); await batch.commit(); alert('Request accepted!');
          },
          leaveSquad: (squadId) => { const batch = writeBatch(db); batch.update(doc(db, "squads", squadId), { members: arrayRemove(state.currentUser.uid) }); batch.update(doc(db, "users", state.currentUser.uid), { squadId: null }); return batch.commit(); },
          kickMember: (squadId, memberId) => { const batch = writeBatch(db); batch.update(doc(db, "squads", squadId), { members: arrayRemove(memberId) }); batch.update(doc(db, "users", memberId), { squadId: null }); return batch.commit(); },
          deleteSquad: async (squadId, memberIds) => { const batch = writeBatch(db); batch.delete(doc(db, "squads", squadId)); (memberIds || []).forEach(id => batch.update(doc(db, "users", id), { squadId: null })); await batch.commit(); },
          deleteDuo: async (partnerId, memberIds) => { const batch = writeBatch(db); batch.delete(doc(db, "partners", partnerId)); (memberIds || []).forEach(id => batch.update(doc(db, "users", id), { partnerId: null })); await batch.commit(); }
      };

      const appController = {
        init() {
            document.body.addEventListener('click', this.handleGlobalClick.bind(this));
            document.body.addEventListener('submit', this.handleGlobalSubmit.bind(this));
            onAuthStateChanged(auth, this.handleAuthStateChange.bind(this));
        },
        handleAuthStateChange(user) {
            this.cleanupListeners();
            if (user) {
                state.currentUser = user;
                bottomNav.classList.remove('hidden');
                setupNotifications(user.uid);
                state.listeners.userData = services.listenToUserData(user.uid, (userData) => {
                    const isInitialLoad = !state.currentUserData;
                    state.currentUserData = userData;
                    if (isInitialLoad) {
                        this.navigateTo('homeScreen', true);
                        if (userData && !userData.hasSeenWelcomePopup) {
                            services.listenToDocument('app', 'welcomePopup', (popupData) => {
                                if(popupData) this.toggleModal('welcomeModal', true, popupData);
                            });
                        }
                    } else {
                        this.refreshCurrentScreen();
                    }
                });
            } else {
                state.currentUser = null;
                state.currentUserData = null;
                bottomNav.classList.add('hidden');
                contactFab.classList.add('hidden');
                this.navigateTo('loginScreen', true);
            }
        },
        handleGlobalClick(e) {
            const target = e.target;
            const screenTarget = target.closest('[data-screen]'); if (screenTarget) { this.navigateTo(screenTarget.dataset.screen); return; }
            if (target.closest('.user-card')) {
                const userId = target.closest('.user-card').dataset.userId;
                getDoc(doc(db, 'users', userId)).then(docSnap => {
                    if (docSnap.exists()) {
                        this.toggleModal('userDetailsModal', true, {id: docSnap.id, ...docSnap.data()});
                    }
                });
                return;
            }
             if (target.closest('.squad-card')) {
                const squadId = target.closest('.squad-card').dataset.squadId;
                this.toggleModal('squadDetailsModal', true, {}); // Show loading state
                services.getSquadDetails(squadId).then(squadData => {
                    if (squadData) {
                        this.toggleModal('squadDetailsModal', true, squadData);
                    }
                });
                return;
            }
            if (target.closest('#backBtn')) { this.navigateBack(); return; }
            if (target.id === 'showRegister') this.navigateTo('registerScreen');
            if (target.id === 'showLogin') this.navigateTo('loginScreen');
            if (target.id === 'forgotPassword') { const email = prompt("Please enter your email to reset your password:"); if(email) services.resetPassword(email).then(() => alert('Password reset email sent!')).catch(err => alert(`Error: ${err.message}`)); }
            if (target.id === 'logoutBtn') services.logoutUser();
            if (target.id === 'updatePhotoBtn') { const url = document.getElementById('photoUrlInput').value; if(url) services.updateUserPhoto(url).then(() => alert("Photo updated!")).catch(err => alert(err.message)); }
            if (target.id === 'editProfileBtn') this.toggleModal('editProfileModal', true, state.currentUserData);
            if (target.id === 'createSquadBtn') this.toggleModal('createSquadModal', true);
            if (target.id === 'addTakaBtn') this.toggleModal('addTakaModal', true);
            if (target.id === 'withdrawTakaBtn') this.toggleModal('withdrawTakaModal', true, state.currentUserData.balance);
            if (target.id === 'inviteSquadBtn') this.openInviteModal();
            if (target.id === 'sendInvitesBtn') this.handleSendInvites();
            if (target.id === 'welcomeGoToGuideBtn') { this.toggleModal(null, false); this.navigateTo('guideScreen'); if(state.currentUser) updateDoc(doc(db, "users", state.currentUser.uid), { hasSeenWelcomePopup: true }); }
            if (target.closest('.close-modal-btn')) { if(target.closest('#welcomeModal') && state.currentUser) { updateDoc(doc(db, "users", state.currentUser.uid), { hasSeenWelcomePopup: true }); } this.toggleModal(null, false); }
            const tournamentCard = target.closest('.tournament-card-clickable'); if (tournamentCard) { const tournament = state.loadedData.tournaments[tournamentCard.dataset.tournamentId]; if(tournament) this.toggleModal('detailsModal', true, { tournament }); }
            const joinBtn = target.closest('.join-btn'); if(joinBtn) services.registerForTournament(joinBtn.dataset.tournamentId, joinBtn.dataset.type).then(() => alert('Registration successful!')).catch(err => alert(`Registration failed: ${err.message}`));
            const joinSquadBtn = target.closest('.join-squad-btn'); if(joinSquadBtn) services.sendRequest('squad_join', joinSquadBtn.dataset.adminId, { squadId: joinSquadBtn.dataset.squadId, squadName: joinSquadBtn.dataset.squadName }).then(()=>alert('Request Sent!')).catch(err => alert(err.message));
            const invitePartnerBtn = target.closest('.invite-partner-btn'); if(invitePartnerBtn) services.sendRequest('partner_request', invitePartnerBtn.dataset.userId).then(()=>alert('Request Sent!')).catch(err => alert(err.message));
            const newsItem = target.closest('[data-news-content]'); if (newsItem) alert(`${newsItem.dataset.newsTitle}\n\n${newsItem.dataset.newsContent}`);
            const tourChatBtn = target.closest('.tournament-chat-btn'); if (tourChatBtn) this.openChat({ type: 'tournament', id: `${tourChatBtn.dataset.type}_${tourChatBtn.dataset.tournamentId}` });
            const resultBtn = target.closest('.result-btn'); if(resultBtn) this.navigateTo('tournamentResultScreen', false, { tournamentId: resultBtn.dataset.tournamentId, type: resultBtn.dataset.type });
            const qualifyBtn = target.closest('.qualify-btn'); if(qualifyBtn) this.navigateTo('qualifyGroupsScreen', false, { tournamentId: qualifyBtn.dataset.tournamentId, type: qualifyBtn.dataset.type });
            const qualifyGroupItem = target.closest('.qualify-group-item'); if(qualifyGroupItem) this.openChat({type: 'qualify_group', id: `qualify_${qualifyGroupItem.dataset.groupId}`});
            const squadChatBtn = target.closest('.squad-chat-btn'); if(squadChatBtn) this.openChat({ type: 'squad', id: state.currentUserData.squadId });
            const partnerChatBtn = target.closest('.partner-chat-btn'); if(partnerChatBtn) this.openChat({ type: 'partner', id: state.currentUserData.partnerId });
            const tabBtn = target.closest('.tab-btn');
            if (tabBtn) { const tabContainer = tabBtn.parentElement; tabContainer.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active'); b.classList.add('text-text-secondary', 'border-transparent'); }); tabBtn.classList.add('active'); tabBtn.classList.remove('text-text-secondary', 'border-transparent'); tabContainer.parentElement.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden')); document.getElementById(`${tabBtn.dataset.tab}Tab`).classList.remove('hidden'); }
            const reqItem = target.closest('[data-req-data]');
            if(reqItem) {
                const reqData = JSON.parse(reqItem.dataset.reqData);
                if(target.matches('.accept-btn')) services.handleRequestResponse(reqData, true).catch(err => alert(`Action Failed: ${err.message}`));
                if(target.matches('.reject-btn')) services.handleRequestResponse(reqData, false).catch(err => alert(`Action Failed: ${err.message}`));
                if(target.matches('.cancel-btn')) services.deleteRequest(reqData.id).catch(err => alert(err.message));
            }
            const leaveSquadBtn = target.closest('.leave-squad-btn'); if(leaveSquadBtn && confirm("Are you sure you want to leave the squad?")) { services.leaveSquad(leaveSquadBtn.dataset.squadId); }
            const kickMemberBtn = target.closest('.kick-member-btn'); if(kickMemberBtn && confirm("Are you sure you want to kick this member?")) { services.kickMember(state.currentUserData.squadId, kickMemberBtn.dataset.memberId); }
            const deleteSquadBtn = target.closest('.delete-squad-btn'); if(deleteSquadBtn && confirm("DANGER: Are you sure you want to delete this squad? This action cannot be undone.")) { services.deleteSquad(deleteSquadBtn.dataset.squadId, JSON.parse(deleteSquadBtn.dataset.memberIds)); }
            const deleteDuoBtn = target.closest('.delete-duo-btn'); if(deleteDuoBtn && confirm("Are you sure you want to end this partnership?")) { services.deleteDuo(deleteDuoBtn.dataset.partnerId, JSON.parse(deleteDuoBtn.dataset.memberIds)); }
        },
        handleGlobalSubmit(e) {
            e.preventDefault(); const form = e.target;
            if (form.id === 'loginForm') services.loginUser(form.loginEmail.value, form.loginPassword.value).catch(err => alert(`Login failed: ${err.message}`));
            if (form.id === 'registerForm') services.registerUser(form.registerUsername.value, form.registerIngameName.value, form.registerIngameUID.value, form.registerEmail.value, form.registerPassword.value).catch(err => console.error(err));
            if (form.id === 'editProfileForm') { services.updateUserProfile(form.editUsername.value, form.editIngameName.value, form.editIngameUID.value).then(() => { alert("Profile Updated!"); this.toggleModal(null, false); }).catch(err => alert(err.message)); }
            if (form.id === 'createSquadForm') { services.createSquad(form.squadNameInput.value, form.squadLogoUrlInput.value, form.squadBioInput.value).then(() => { this.toggleModal(null, false); this.navigateTo('mySquadScreen'); }).catch(err => alert(err.message)); }
            if (form.id === 'chatForm') { const input = form.chatMessageInput; const text = input.value.trim(); if(text && state.currentChatContext) { services.sendChatMessage(state.currentChatContext.id, text); input.value = ''; } }
            if (form.id === 'addTakaForm') { const data = { amount: Number(form.takaAmount.value), method: form.takaMethod.value, number: form.takaNumber.value, trxId: form.takaTrxId.value }; services.createTakaRequest(data).then(() => { alert('Request submitted successfully!'); this.toggleModal(null, false); }).catch(err => alert(`Error: ${err.message}`)); }
            if (form.id === 'withdrawTakaForm') { const data = { amount: Number(form.withdrawAmount.value), method: form.withdrawMethod.value, number: form.withdrawNumber.value }; services.createWithdrawRequest(data).then(() => { alert('Withdrawal request submitted!'); this.toggleModal(null, false); }).catch(err => alert(`Error: ${err.message}`)); }
        },
        _renderScreen(screenId, context = {}) {
            this.cleanupListeners(screenId);
            mainContent.innerHTML = ui.loading(); 
            state.currentScreen = screenId;
            state.currentScreenContext = context;
            let screenHtml = ui[screenId] ? ui[screenId](state.currentUserData) : (screenId.includes('TournamentsScreen') ? ui.tournamentsScreen(screenId.replace('TournamentsScreen', '')) : `<div class="p-5">Screen not found: ${screenId}</div>`);
            mainContent.innerHTML = screenHtml;
            
            if (state.currentUser && (screenId === 'walletScreen' || screenId === 'profileScreen')) {
                contactFab.classList.remove('hidden');
            } else {
                contactFab.classList.add('hidden');
            }

            this.updateHeader(); 
            this.updateActiveNav(); 
            this.loadScreenData(screenId, context);
        },
        navigateTo(screenId, isInitial = false, context = {}) {
            if (!screenId) return;
            const lastScreen = state.screenHistory[state.screenHistory.length - 1];
            if (isInitial) { 
                state.screenHistory = [{screenId, context}]; 
            } else if (!lastScreen || lastScreen.screenId !== screenId) { 
                state.screenHistory.push({screenId, context}); 
            }
            this._renderScreen(screenId, context);
        },
        navigateBack() {
            if (state.screenHistory.length <= 1) return;
            if(state.currentScreen === 'chatScreen') state.currentChatContext = null;
            state.screenHistory.pop();
            const prev = state.screenHistory[state.screenHistory.length - 1];
            if (prev) {
                this._renderScreen(prev.screenId, prev.context);
            }
        },
        loadScreenData(screenId, context = {}) {
            if (screenId === 'homeScreen') {
                pageTitle.textContent = "Tourition Hub";
                state.listeners.banner = services.listenToBanner(data => { if(data && document.getElementById('homeBanner')) { document.getElementById('homeBanner').style.backgroundImage = `url('${data.imageUrl}')`; document.getElementById('bannerTitle').textContent = data.title; }});
                state.listeners.news = services.listenToNews(news => { if(document.getElementById('newsContainer')) document.getElementById('newsContainer').innerHTML = news.length ? news.map(ui.newsItem).join('') : `<p class="text-sm text-center text-text-secondary">No news yet.</p>`; });
                state.listeners.appUpdate = services.listenToAppUpdate(updateData => {
                    const section = document.getElementById('appUpdateSection');
                    const container = document.getElementById('appUpdateContainer');
                    if (updateData && updateData.version && updateData.version !== currentAppVersion && section && container) {
                        container.innerHTML = ui.updateCard(updateData);
                        section.classList.remove('hidden');
                    } else if (section) {
                        section.classList.add('hidden');
                    }
                });
            }
            else if(screenId === 'leaderboardScreen') {
                const container = document.getElementById('leaderboardContainer');
                const q = query(collection(db, 'users'), orderBy('ratingPoints', 'desc'), limit(50));
                state.listeners[screenId] = onSnapshot(q, snap => {
                    if (container) {
                        container.innerHTML = snap.docs.map((doc, index) => {
                            const user = doc.data();
                            const rank = index + 1;
                            const rankColor = rank === 1 ? 'text-yellow-400' : (rank === 2 ? 'text-gray-300' : (rank === 3 ? 'text-yellow-600' : 'text-text-secondary'));
                            return `<div class="bg-card-bg rounded-xl p-3 flex items-center gap-4"><span class="font-bold text-lg w-8 text-center ${rankColor}">${rank}</span><img src="${user.photoURL}" class="w-10 h-10 rounded-full object-cover"><div class="flex-1"><h4 class="font-medium text-sm">${user.username}</h4><p class="text-xs text-text-secondary">Rating: ${user.ratingPoints || 0}</p></div></div>`;
                        }).join('');
                    }
                });
            }
            else if(screenId === 'membersScreen') { 
                const container = document.getElementById('membersListContainer'); 
                if(container) {
                    state.listeners[screenId] = services.listenToList('users', users => { 
                        container.innerHTML = users.map(u => ui.userCard(u)).join(''); 
                    });
                }
            }
             else if(screenId === 'squadsScreen') { 
                const container = document.getElementById('squadsListContainer'); 
                if(container) {
                    state.listeners[screenId] = services.listenToList('squads', squads => { 
                        container.innerHTML = squads.map(s => ui.squadCard(s)).join(''); 
                    });
                }
            }
            else if (screenId.includes('TournamentsScreen')) {
                const type = screenId.replace('TournamentsScreen', ''); const container = document.getElementById(`${type}TournamentsContainer`);
                if(container) state.listeners[screenId] = services.listenToTournaments(type, tournaments => { state.loadedData.tournaments = {}; container.innerHTML = tournaments.length ? tournaments.map(t => { state.loadedData.tournaments[t.id] = t; return ui.tournamentCard(t, type).outerHTML; }).join('') : `<p class="text-sm text-center text-text-secondary">No tournaments found.</p>`; });
            }
            else if (screenId === 'tournamentResultScreen') {
                const container = document.getElementById('tournamentResultContainer');
                state.listeners[screenId] = services.listenToDocument(`tournaments/${context.type}/items`, context.tournamentId, (tData) => {
                    if (container) {
                        if (tData && tData.results && tData.results.length > 0) {
                            container.innerHTML = tData.results.map(res => `<div class="bg-card-bg rounded-xl p-4"><h4 class="font-bold mb-3">${res.title}</h4><img src="${res.imageUrl}" class="w-full rounded-lg"></div>`).reverse().join('');
                        } else { container.innerHTML = `<p class="text-sm text-center text-text-secondary">No results have been posted yet.</p>`; }
                    }
                });
            }
            else if (screenId === 'qualifyGroupsScreen') {
                const container = document.getElementById('qualifyGroupsContainer');
                const path = `tournaments/${context.type}/items/${context.tournamentId}/qualifyGroups`;
                state.listeners[screenId] = services.listenToSubCollection(path, (groups) => {
                    if (container) {
                        const myIdentifier = context.type === 'squad' ? state.currentUserData.squadId : (context.type === 'duo' ? state.currentUserData.partnerId : state.currentUserData.id);
                        const myGroups = groups.filter(g => g.members && g.members.includes(myIdentifier));
                        if (myGroups.length > 0) {
                            container.innerHTML = myGroups.map(g => `<div class="qualify-group-item bg-card-bg rounded-xl p-4 flex items-center gap-4 cursor-pointer" data-group-id="${g.id}"><i class="fas fa-crown w-6 text-center text-yellow-400"></i><span>${g.name}</span></div>`).join('');
                        } else { container.innerHTML = `<p class="text-sm text-center text-text-secondary">You are not in any qualified groups for this tournament.</p>`; }
                    }
                });
            }
            else if (screenId === 'mySquadScreen') {
                const { squadId } = state.currentUserData;
                if(squadId) {
                    document.getElementById('squadDetailsView')?.classList.remove('hidden'); 
                    document.getElementById('noSquadView')?.classList.add('hidden');
                    state.listeners[screenId] = services.listenToSquadDetails(squadId, (squadData) => { 
                        if(squadData) { 
                            const isCurrentUserAdmin = state.currentUser.uid === squadData.adminId;
                            let actionsHtml = `<button class="squad-chat-btn w-full py-3 rounded-lg bg-cyan-500 font-semibold">Private Chat</button>`;
                            if (isCurrentUserAdmin) { actionsHtml += `<button id="inviteSquadBtn" class="w-full py-3 rounded-lg bg-blue-500 font-semibold">Invite Members</button><button class="delete-squad-btn w-full py-3 rounded-lg bg-danger font-semibold" data-squad-id="${squadData.id}" data-member-ids='${JSON.stringify(squadData.members || [])}'>Delete Squad</button>`; } else { actionsHtml += `<button class="leave-squad-btn w-full py-3 rounded-lg bg-warning font-semibold" data-squad-id="${squadData.id}">Exit Squad</button>`; }
                            document.getElementById('squadActionsContainer').innerHTML = actionsHtml;
                            document.getElementById('mySquadName').textContent = squadData.name; document.getElementById('mySquadBio').textContent = squadData.bio; document.getElementById('mySquadLogo').src = squadData.logoURL; document.getElementById('squadMemberCount').textContent = `Members: ${(squadData.members || []).length}/5`; 
                            document.getElementById('mySquadMembersContainer').innerHTML = squadData.memberDetails.map(m => ui.squadMemberListItem(m, squadData.adminId)).join(''); 
                        } else { this.refreshCurrentScreen(); }
                    });
                } else { document.getElementById('squadDetailsView')?.classList.add('hidden'); document.getElementById('noSquadView')?.classList.remove('hidden'); }
            }
            else if (screenId === 'duoPartnerScreen') {
                const { partnerId } = state.currentUserData;
                if(partnerId) {
                     document.getElementById('partnerDetailsView')?.classList.remove('hidden'); document.getElementById('noPartnerView')?.classList.add('hidden');
                     state.listeners[screenId] = services.listenToPartnerDetails(partnerId, (partnerData) => { 
                         if(partnerData && partnerData.partnerInfo) { 
                             document.getElementById('partnerActionsContainer').innerHTML = `<button class="partner-chat-btn w-full py-3 rounded-lg bg-cyan-500 font-semibold">Private Chat</button><button class="delete-duo-btn w-full py-3 rounded-lg bg-danger font-semibold mt-2" data-partner-id="${partnerData.id}" data-member-ids='${JSON.stringify(partnerData.members)}'>Delete Duo</button>`;
                             document.getElementById('myPartnerName').textContent = partnerData.name; document.getElementById('myPartnerLogo').src = partnerData.partnerInfo.photoURL; 
                             document.getElementById('myPartnerContainer').innerHTML = ui.userListItem(partnerData.partnerInfo).outerHTML; 
                         } else { this.refreshCurrentScreen(); }
                     });
                } else {
                    document.getElementById('partnerDetailsView')?.classList.add('hidden'); document.getElementById('noPartnerView')?.classList.remove('hidden');
                    const availableContainer = document.getElementById('availablePartnersContainer');
                    state.listeners[screenId] = services.listenToAvailablePartners(users => { availableContainer.innerHTML = users.length === 0 ? `<p class="text-sm text-center text-text-secondary">No players available.</p>` : users.map(u => ui.userListItem(u, { showInviteButton: true }).outerHTML).join(''); });
                }
            }
            else if(screenId === 'requestsScreen') {
                const receivedContainer = document.getElementById('receivedRequestsContainer');
                state.listeners.receivedRequests = services.listenToRequests('received', requests => { receivedContainer.innerHTML = requests.length ? requests.map(req => ui.requestItem(req, 'received')).join('') : `<p class="text-sm text-center text-text-secondary">No new requests.</p>`; });
                const sentContainer = document.getElementById('sentRequestsContainer');
                state.listeners.sentRequests = services.listenToRequests('sent', requests => { sentContainer.innerHTML = requests.length ? requests.map(req => ui.requestItem(req, 'sent')).join('') : `<p class="text-sm text-center text-text-secondary">No sent requests.</p>`; });
            }
            else if(screenId === 'chatScreen' && state.currentChatContext) {
                 const container = document.getElementById('chatMessagesContainer');
                 state.listeners[screenId] = services.listenToChatMessages(state.currentChatContext.id, messages => {
                    container.innerHTML = messages.map(ui.chatMessageItem).join('');
                    if(container.children.length > 0) container.lastElementChild.scrollIntoView({ behavior: 'smooth' });
                 });
            }
             else if(screenId === 'walletScreen') {
                const container = document.getElementById('transactionHistory');
                state.listeners[screenId] = services.listenToTransactions(state.currentUser.uid, transactions => { container.innerHTML = transactions.length ? transactions.map(ui.transactionItem).join('') : `<p class="text-sm text-center text-text-secondary">No transactions yet.</p>` });
            }
            else if(screenId === 'noticeScreen') {
                const container = document.getElementById('noticeContainer');
                state.listeners[screenId] = services.listenToCollection('noticeboard', notices => { container.innerHTML = notices.length ? notices.map(ui.noticeItem).join('') : `<p class="text-sm text-center text-text-secondary">No notices available.</p>` });
            }
            else if(screenId === 'rulesScreen') {
                const container = document.getElementById('rulesContainer');
                state.listeners[screenId] = services.listenToDocument('app_content', 'rules', rules => { container.innerHTML = rules ? rules.content : 'Rules are not available yet.'; });
            }
             else if(screenId === 'guideScreen') {
                const container = document.getElementById('guidesContainer');
                state.listeners[screenId] = services.listenToCollection('guides', guides => { container.innerHTML = guides.length ? guides.map(ui.guideItem).join('') : `<p class="text-sm text-center text-text-secondary">No guides available.</p>`; });
            }
            else if(screenId === 'contactScreen') {
                const container = document.getElementById('contactContainer');
                state.listeners[screenId] = services.listenToDocument('app_content', 'contact', (data) => { container.innerHTML = data && data.items ? data.items.map(ui.contactItem).join('') : `<p class="text-sm text-center text-text-secondary">Contact information is not available.</p>`; });
            }
        },
        async openInviteModal() {
            this.toggleModal('inviteUserModal', true);
            const listContainer = document.getElementById('inviteUserList');
            listContainer.innerHTML = ui.loading();
            const inviteableUsers = await services.getUsers([where('squadId', '==', null)]);
            if (inviteableUsers.length === 0) { listContainer.innerHTML = `<p class="text-center text-text-secondary">No users available to invite.</p>`; return; }
            listContainer.innerHTML = inviteableUsers.filter(u => u.id !== state.currentUser.uid).map(user => `<div class="flex items-center justify-between p-2 rounded-lg hover:bg-primary-bg"><div class="flex items-center gap-3"><img src="${user.photoURL}" class="w-10 h-10 rounded-full"><span class="text-sm">${user.username}</span></div><input type="checkbox" value="${user.id}" class="form-checkbox h-5 w-5 bg-card-bg border-white/20 rounded text-accent focus:ring-accent"></div>`).join('');
        },
        async handleSendInvites() {
            const selectedUsers = Array.from(document.querySelectorAll('#inviteUserList input:checked')).map(cb => cb.value);
            if (selectedUsers.length === 0) throw new Error("Please select at least one user to invite.");
            const squadDoc = await getDoc(doc(db, 'squads', state.currentUserData.squadId));
            const { name: squadName } = squadDoc.data();
            for (const userId of selectedUsers) { await services.sendRequest('squad_invite', userId, { squadId: state.currentUserData.squadId, squadName }); }
            alert(`${selectedUsers.length} invite(s) sent.`);
            this.toggleModal(null, false);
        },
        openChat(context) { state.currentChatContext = context; this.navigateTo('chatScreen'); },
        refreshCurrentScreen() { if (!state.currentScreen) return; this._renderScreen(state.currentScreen, state.currentScreenContext); },
        updateHeader() {
            const isAuth = ['loginScreen', 'registerScreen'].includes(state.currentScreen);
            const isHome = state.currentScreen === 'homeScreen';
            backBtn.style.visibility = (isHome || isAuth || state.screenHistory.length <= 1) ? 'hidden' : 'visible';
            menuBtn.classList.toggle('hidden', isAuth || isHome || !state.currentUserData);
            if(isHome) {
                pageTitle.textContent = "Tourition Hub";
            } else {
                let titleText = (state.currentScreen || '').replace(/([A-Z])/g, ' $1').replace('Screen', '').trim();
                if(state.currentScreen === 'chatScreen') titleText = 'Chat';
                pageTitle.textContent = titleText.charAt(0).toUpperCase() + titleText.slice(1);
            }
        },
        updateActiveNav() { document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.screen === state.currentScreen)); },
        toggleModal(modalName, show, data = {}) { if (show) { modalContainer.innerHTML = ui[modalName] ? ui[modalName](data) : ''; } else { modalContainer.innerHTML = ''; } },
        cleanupListeners(newScreenId = null) {
            for (const key in state.listeners) { if (key !== 'userData' && key !== newScreenId) { if (typeof state.listeners[key] === 'function') { state.listeners[key](); delete state.listeners[key]; } } }
            if (newScreenId === null) { if(state.listeners.userData) state.listeners.userData(); state.listeners = {}; }
        }
      };
      appController.init();
    </script>
</body>
</html>